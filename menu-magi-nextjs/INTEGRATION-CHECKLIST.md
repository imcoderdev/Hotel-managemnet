# üîß INTEGRATION CHECKLIST - Actually Connect the Features

## ‚ùå CURRENT STATUS: Features exist but NOT connected to app

All the libraries (GST, notifications, WhatsApp, i18n, image upload) are created but **NOT USED** in your pages.

---

## ‚úÖ STEP-BY-STEP INTEGRATION (Do in Order)

### 1Ô∏è‚É£ DATABASE SETUP (Required First!)

**Run SQL scripts in Supabase Dashboard:**

1. Go to: https://supabase.com ‚Üí Your Project ‚Üí SQL Editor
2. Run **FIRST**: `supabase-performance-fixes.sql` (fixes column issues)
3. Run **SECOND**: `supabase-india-schema.sql` (adds GST tables)
4. Go to: Storage ‚Üí Create bucket ‚Üí Name: `menu-images` ‚Üí Public: ‚úÖ Yes

**Verification:**
```sql
-- Check if new columns exist
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'orders' AND column_name IN ('gst_amount', 'cgst', 'sgst', 'invoice_number');
```

---

### 2Ô∏è‚É£ INTEGRATE GST IN CHECKOUT PAGE

**File:** `app/customer/checkout/page.tsx`

**CHANGE 1: Add GST import** (line 1-5)
```typescript
import { calculateGST, formatIndianCurrency } from '@/lib/gst';
import { shareOnWhatsApp, getOrderConfirmationMessage } from '@/lib/whatsapp';
```

**CHANGE 2: Replace tax calculation** (around line 50)
```typescript
// ‚ùå OLD CODE (line 50):
const tax = subtotal * 0.1; // 10% tax

// ‚úÖ NEW CODE:
const gstRate = 5; // 5% GST for restaurants (configurable)
const gstCalculation = calculateGST(subtotal, gstRate, false); // false = same state (CGST+SGST)
const tax = gstCalculation.total;
```

**CHANGE 3: Update order creation** (around line 70)
```typescript
// ‚ùå OLD CODE:
const { data: orderData, error: orderError } = await supabase
  .from('orders')
  .insert({
    owner_id: ownerId,
    table_number: tableNumber,
    status: 'waiting',
    subtotal,
    tax,
    total,
    payment_status: 'paid',
    payment_method: 'demo',
  })

// ‚úÖ NEW CODE:
const { data: orderData, error: orderError } = await supabase
  .from('orders')
  .insert({
    owner_id: ownerId,
    table_number: tableNumber,
    status: 'waiting',
    subtotal,
    tax,
    total,
    payment_status: 'paid',
    payment_method: 'cash', // or 'upi', 'card'
    gst_rate: gstRate,
    gst_amount: gstCalculation.gstAmount,
    cgst: gstCalculation.cgst,
    sgst: gstCalculation.sgst,
    // invoice_number will be auto-generated by trigger
  })
```

**CHANGE 4: Add WhatsApp share button** (after order success, around line 95)
```typescript
// After successful order, add this:
toast.success('Payment successful! Order placed.');

// ‚úÖ ADD THIS:
const whatsappMessage = getOrderConfirmationMessage({
  orderNumber: orderData.invoice_number || orderData.id.slice(-6),
  restaurantName: 'Your Restaurant', // Get from owner data
  items: cart.map(item => ({
    name: item.name,
    quantity: item.quantity,
    price: item.price
  })),
  total: total,
  tableNumber: tableNumber
});

// Show WhatsApp share option
if (confirm('Share order confirmation on WhatsApp?')) {
  shareOnWhatsApp(whatsappMessage, ''); // Customer's phone
}

router.push(`/customer/confirmation/${orderData.id}`);
```

**CHANGE 5: Update UI to show GST breakdown** (around line 150)
```typescript
// ‚ùå OLD CODE:
<div className="flex justify-between text-muted-foreground">
  <span>Tax (10%)</span>
  <span>${tax.toFixed(2)}</span>
</div>

// ‚úÖ NEW CODE:
<div className="space-y-1">
  <div className="flex justify-between text-sm text-muted-foreground">
    <span>CGST (2.5%)</span>
    <span>‚Çπ{formatIndianCurrency(gstCalculation.cgst)}</span>
  </div>
  <div className="flex justify-between text-sm text-muted-foreground">
    <span>SGST (2.5%)</span>
    <span>‚Çπ{formatIndianCurrency(gstCalculation.sgst)}</span>
  </div>
  <div className="flex justify-between font-medium">
    <span>Total GST (5%)</span>
    <span>‚Çπ{formatIndianCurrency(gstCalculation.gstAmount)}</span>
  </div>
</div>
```

---

### 3Ô∏è‚É£ INTEGRATE IMAGE UPLOAD IN DASHBOARD

**File:** `app/owner/dashboard/page.tsx`

**CHANGE 1: Add upload import** (line 1-5)
```typescript
import { uploadImage, deleteImage } from '@/lib/uploadImage';
```

**CHANGE 2: Replace image handling** (around line 160)
```typescript
// ‚ùå OLD CODE:
const handleImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (file) {
    const reader = new FileReader();
    reader.onloadend = () => {
      const result = reader.result as string;
      setImagePreview(result);
      setFormImage(result); // This is base64 - BAD!
    };
    reader.readAsDataURL(file);
  }
};

// ‚úÖ NEW CODE:
const [isUploading, setIsUploading] = useState(false);

const handleImageChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (!file) return;

  setIsUploading(true);
  toast.info('Uploading image...');

  try {
    // Upload to Supabase Storage (automatic compression)
    const imageUrl = await uploadImage(file, 'menu-items');
    
    setFormImage(imageUrl); // CDN URL instead of base64
    setImagePreview(imageUrl);
    toast.success('Image uploaded successfully!');
  } catch (error: any) {
    console.error('Upload error:', error);
    toast.error('Failed to upload image: ' + error.message);
  } finally {
    setIsUploading(false);
  }
};
```

**CHANGE 3: Delete old image when updating** (around line 220)
```typescript
// In handleSubmit, before updating:
if (editingItem && editingItem.image_url && formImage !== editingItem.image_url) {
  // Delete old image from storage
  try {
    await deleteImage(editingItem.image_url);
  } catch (error) {
    console.warn('Failed to delete old image:', error);
  }
}
```

---

### 4Ô∏è‚É£ INTEGRATE NOTIFICATIONS IN ORDERS PAGE

**File:** `app/owner/orders/page.tsx`

**CHANGE 1: Add notification imports** (line 1-5)
```typescript
import { 
  requestNotificationPermission, 
  notifyNewOrder, 
  notifyOrderStatusChange,
  playNotificationSound 
} from '@/lib/notifications';
```

**CHANGE 2: Request permission on load** (in useEffect, around line 30)
```typescript
useEffect(() => {
  checkAuthAndLoadOrders();
  
  // ‚úÖ ADD THIS:
  // Request notification permission
  requestNotificationPermission();
  
  // Set up realtime subscription
  const channel = supabase
    .channel('orders-changes')
    .on(
      'postgres_changes',
      {
        event: 'INSERT', // Only new orders
        schema: 'public',
        table: 'orders'
      },
      (payload) => {
        console.log('New order received:', payload);
        
        // ‚úÖ PLAY SOUND + NOTIFY:
        playNotificationSound();
        notifyNewOrder({
          orderNumber: payload.new.id.slice(-6),
          tableNumber: payload.new.table_number,
          total: payload.new.total
        });
        
        loadOrders();
      }
    )
    .subscribe();

  return () => {
    supabase.removeChannel(channel);
  };
}, []);
```

**CHANGE 3: Notify on status changes** (in handleStatusUpdate, around line 100)
```typescript
const handleStatusUpdate = async (orderId: string, newStatus: Order['status'], message: string) => {
  try {
    const { error } = await supabase
      .from('orders')
      .update({ status: newStatus })
      .eq('id', orderId);

    if (error) throw error;

    toast.success(message);
    
    // ‚úÖ ADD THIS:
    notifyOrderStatusChange(newStatus, message);
    
    loadOrders();
  } catch (error: any) {
    console.error('Error updating status:', error);
    toast.error('Failed to update order status');
  }
};
```

---

### 5Ô∏è‚É£ ADD LANGUAGE TOGGLE (OPTIONAL)

**File:** `app/customer/menu/page.tsx`

**Add at top of component:**
```typescript
import { useTranslation } from '@/lib/i18n';

export default function CustomerMenuPage() {
  const { t, language, toggleLanguage } = useTranslation();
  
  // Then replace hardcoded text:
  // "Add to Cart" ‚Üí {t('addToCart')}
  // "Menu" ‚Üí {t('menu')}
  // etc.
  
  // Add language toggle button:
  <Button onClick={toggleLanguage}>
    {language === 'en' ? 'üáÆüá≥ ‡§π‡§ø‡§Ç‡§¶‡•Ä' : 'üá¨üáß English'}
  </Button>
}
```

---

## üß™ TESTING CHECKLIST

After making changes above:

### Test GST Calculation:
1. ‚úÖ Add items to cart
2. ‚úÖ Go to checkout
3. ‚úÖ Verify you see "CGST (2.5%)" and "SGST (2.5%)"
4. ‚úÖ Check amounts are in ‚Çπ not $

### Test Image Upload:
1. ‚úÖ Owner dashboard ‚Üí Add menu item
2. ‚úÖ Upload image ‚Üí should show "Uploading..." toast
3. ‚úÖ Check Supabase Storage has the image
4. ‚úÖ Image should be compressed (check file size)

### Test Notifications:
1. ‚úÖ Owner ‚Üí Orders page (keep open)
2. ‚úÖ Customer ‚Üí Place new order
3. ‚úÖ Owner should hear sound + see notification
4. ‚úÖ Check browser notification permission is granted

### Test WhatsApp:
1. ‚úÖ Customer places order
2. ‚úÖ Should see "Share on WhatsApp?" prompt
3. ‚úÖ Click Yes ‚Üí opens WhatsApp with formatted message

### Test Database:
1. ‚úÖ Check orders table has gst_amount, cgst, sgst columns
2. ‚úÖ Check invoice_number is auto-generated (format: INV/2024/10/00001)
3. ‚úÖ Check rate limiting works (try placing 4 orders in 5 minutes)

---

## üìä VERIFICATION QUERIES

Run in Supabase SQL Editor to verify integration:

```sql
-- Check if GST data is being saved
SELECT 
  invoice_number,
  subtotal,
  gst_rate,
  cgst,
  sgst,
  gst_amount,
  total
FROM orders
ORDER BY created_at DESC
LIMIT 5;

-- Check if images are in storage (not base64)
SELECT 
  name,
  LENGTH(image_url) as url_length,
  CASE 
    WHEN image_url LIKE 'data:image%' THEN 'BASE64 ‚ùå'
    WHEN image_url LIKE '%supabase.co/storage%' THEN 'STORAGE ‚úÖ'
    ELSE 'UNKNOWN'
  END as storage_type
FROM menu_items;

-- Check rate limiting
SELECT * FROM order_rate_limits ORDER BY last_order_time DESC;

-- Check audit logs
SELECT * FROM audit_logs ORDER BY created_at DESC LIMIT 10;
```

---

## ‚ö†Ô∏è COMMON ISSUES & FIXES

### Issue 1: "column gst_amount does not exist"
**Fix:** You didn't run the SQL scripts. Go back to Step 1.

### Issue 2: "storage bucket not found"
**Fix:** Create `menu-images` bucket in Supabase ‚Üí Storage

### Issue 3: Notifications not working
**Fix:** Check browser console for permission errors. Run `requestNotificationPermission()` manually.

### Issue 4: Images still base64
**Fix:** You didn't update the `handleImageChange` function. See Step 3.

### Issue 5: WhatsApp not opening
**Fix:** Check phone number format. Should be international: +919876543210

---

## üéØ FINAL INTEGRATION STATUS

Once you complete all steps above, you'll have:

- ‚úÖ GST calculations with CGST/SGST breakdown
- ‚úÖ Invoice number auto-generation (INV/2024/10/00001)
- ‚úÖ Images stored in Supabase Storage (90% smaller than base64)
- ‚úÖ Real-time notifications with sound for new orders
- ‚úÖ WhatsApp sharing of order confirmations
- ‚úÖ Rate limiting (3 orders per 5 min)
- ‚úÖ Audit trail of all database changes
- ‚úÖ Hindi/English language toggle (optional)

---

## üöÄ NEXT: After Integration Works

1. **Payment Gateway Integration** (when ready):
   - Razorpay: https://razorpay.com/docs/
   - Paytm: https://business.paytm.com/docs
   - PhonePe: https://developer.phonepe.com/

2. **Advanced Features**:
   - SMS notifications via MSG91
   - Email receipts
   - Loyalty points system
   - Discount coupons
   - Analytics dashboard

---

## üí° PRO TIP

**Do one integration at a time:**
1. Start with GST (most visible change)
2. Then image upload (reduces database load)
3. Then notifications (improves UX)
4. Finally WhatsApp (nice-to-have)

Test after each change! Don't integrate everything at once.
